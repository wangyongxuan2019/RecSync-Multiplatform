# 网络连接问题修复说明

## 问题描述

**现象：** 其他电脑连接到同一个WiFi的Client显示"已连接到Leader"，但Leader端未显示已连接的客户端。本机Client可以正常连接。

## 根本原因

1. **Socket绑定问题** - UDP Socket未明确绑定到所有网络接口（0.0.0.0）
2. **Windows防火墙阻止** - 默认阻止跨机器的UDP通信
3. **缺少诊断信息** - 难以快速定位问题

## 修复内容

### 1. 修复Socket绑定 (SoftwareSyncBase.java)

**修改位置：** `recsync-core/src/main/java/com/recsync/core/sync/SoftwareSyncBase.java:40-57`

**关键修改：**
```java
// 明确绑定到所有网络接口（0.0.0.0）
InetSocketAddress bindAddress = new InetSocketAddress("0.0.0.0", rpcPort);
rpcSocket = new DatagramSocket(bindAddress);
```

**效果：** 确保Leader和Client的RPC服务监听所有网络接口，而不仅是localhost。

### 2. 增强诊断日志

**修改文件：**
- `SoftwareSyncBase.java` - RPC消息收发详细日志
- `SoftwareSyncClient.java` - 心跳发送详细日志

**新增日志输出：**
```
✅ RPC服务已启动 - 绑定地址: 0.0.0.0:8244 (监听所有网络接口)
   请确保防火墙允许UDP端口 8244 的入站连接
RPC监听线程已启动，正在监听端口 8244 ...
发送心跳到Leader: 192.168.1.100:8244 - 客户端: Client-XXX, IP: 192.168.1.101, synced: false
收到RPC消息: method=1, payload=Client-XXX,192.168.1.101,false, from=192.168.1.101:45678, size=48字节
```

### 3. 防火墙配置工具

**新增文件：** `配置防火墙.bat`

**功能：**
- 自动添加Windows防火墙规则
- 支持Leader和Client所需的所有端口
- 包含错误处理和详细说明

**使用方法：**
1. 在运行Leader的机器上，右键点击 `配置防火墙.bat`
2. 选择"以管理员身份运行"
3. 按照提示完成配置

**配置的端口：**
- UDP 8244: Leader RPC通信
- UDP 8245: Leader服务发现
- TCP 8246: Leader文件传输
- UDP 8247: Client RPC通信

### 4. 详细故障排除文档

**新增文件：** `TROUBLESHOOTING_NETWORK.md`

**内容包括：**
- 快速修复方案（自动/手动）
- 端口说明表
- 完整故障排除步骤
- 常见问题解答
- 验证连接成功的标志
- 进阶调试方法

---

## 使用步骤

### 第一步：更新代码

代码已经修改完成，运行以下命令重新编译：

```bash
gradlew build
```

### 第二步：配置防火墙（关键！）

**在Leader机器上：**
1. 右键点击 `配置防火墙.bat`
2. 选择"以管理员身份运行"
3. 等待配置完成

**在Client机器上（如果需要）：**
- 通常不需要特别配置
- 如果仍然无法连接，也运行一次 `配置防火墙.bat`

### 第三步：确认网络设置

1. 打开 **设置 → 网络和Internet → WiFi**
2. 点击已连接的WiFi网络
3. 确认网络配置文件为 **"专用"**（而不是"公用"）

### 第四步：启动应用

1. 启动Leader应用
2. 启动Client应用（本机或其他机器）
3. 查看连接状态

**Leader端应该显示：**
```
已连接客户端 (1/10台)
┌─────────────────────────────────────────┐
│✅ Client-XXX (192.168.1.101) - 2.3ms    │
└─────────────────────────────────────────┘
```

**Client端应该显示：**
```
状态: 已连接到Leader ✅
```

---

## 验证连接成功

### Leader端日志：
```
✅ RPC服务已启动 - 绑定地址: 0.0.0.0:8244 (监听所有网络接口)
RPC监听线程已启动，正在监听端口 8244 ...
✅ 新客户端连接: Client-Front (192.168.1.101) - 当前客户端数: 1/10
```

### Client端日志：
```
✅ SoftwareSyncClient已启动: Client-Front, Leader端口: 8244
发送心跳到Leader: 192.168.1.100:8244 - 客户端: Client-Front, IP: 192.168.1.101, synced: false
```

---

## 如果仍然无法连接

### 检查清单：

- [ ] 已重新编译代码
- [ ] 已运行 `配置防火墙.bat`（管理员权限）
- [ ] WiFi设置为"专用网络"
- [ ] 所有设备连接到同一个WiFi
- [ ] 能ping通Leader的IP地址
- [ ] 查看日志确认RPC服务已启动
- [ ] 查看日志确认监听 0.0.0.0

### 进一步排查：

1. **查看防火墙规则：**
```powershell
Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*RecSync*"}
```

2. **查看端口监听：**
```powershell
netstat -an | findstr "8244"
# 应该看到: UDP    0.0.0.0:8244           *:*
```

3. **查看详细日志：**
- 启用TRACE级别日志（编辑logback.xml）
- 查看完整的RPC通信日志

4. **使用Wireshark抓包：**
- 过滤器：`udp.port == 8244`
- 查看是否有UDP数据包

### 联系支持

如果问题仍然存在，请提供：
1. Leader和Client的完整日志
2. `ipconfig /all` 输出
3. 防火墙规则截图
4. 网络拓扑说明

---

## 其他改进

### Client界面布局优化

**修改：** 调整Client窗口为左右分栏布局

**布局说明：**
- **左侧（450px）：** 设备信息、录制状态、文件管理
- **右侧（450px）：** 摄像头预览（缩小为420x315）
- **窗口尺寸：** 950x720（原800x770）

**优势：**
- 更紧凑的布局
- 预览窗口大小适中
- 左侧信息一目了然

---

## 技术细节

### 为什么需要明确绑定到 0.0.0.0？

Java的 `DatagramSocket(int port)` 构造函数在不同平台和网络配置下行为不一致：
- **理论上**：应该绑定到所有接口（0.0.0.0）
- **实际上**：某些配置下可能只绑定到localhost

**解决方案：** 使用 `DatagramSocket(InetSocketAddress)`，明确指定绑定地址。

### 为什么本机Client可以连接？

本机通信使用loopback接口（127.0.0.1），不经过网络接口和防火墙，所以即使Socket绑定不正确或防火墙阻止，本机通信仍然正常。

### 端口选择的考虑

- **RPC端口（8244/8247）：** 使用UDP协议，适合心跳和命令传输
- **文件传输端口（8246）：** 使用TCP协议，保证文件完整性
- **服务发现端口（8245）：** 使用UDP广播，实现自动发现

---

**修复日期：** 2024-01-15
**修复版本：** V1.1
**测试状态：** ✅ 编译通过
