# 🔥 防火墙配置快速指南

## ❓ 脚本应该在哪端运行？

### ✅ 答案：在 **LEADER 端**运行

运行 Leader 应用的电脑需要配置防火墙。

---

## 📝 使用步骤（只需3步）

### Leader 机器上：

1. **找到文件：** `setup-firewall.bat`

2. **右键点击** → 选择 **"以管理员身份运行"**

3. **等待完成**，看到成功提示：
   ```
   [SUCCESS] UDP 8244 - Leader RPC Port
   [SUCCESS] TCP 8246 - Leader File Transfer Port
   [SUCCESS] UDP 8245 - Leader Discovery Port
   [SUCCESS] UDP 8247 - Client RPC Port
   ```

### Client 机器上：

**通常不需要配置** ❌

只有在 Leader 配置后仍然无法连接时，才在 Client 机器上运行此脚本（极少需要）。

---

## 🤔 为什么只在 Leader 端配置？

**Leader = 服务器**
- 需要**监听**端口等待 Client 连接
- 需要**接收**来自 Client 的心跳消息
- 需要**接收**Client 上传的视频文件

**Windows 防火墙默认阻止入站连接**，所以需要允许这些端口。

**Client = 客户端**
- 主动**发起**连接到 Leader（出站连接默认允许）
- 不需要被动监听（除非 Leader 需要主动联系 Client）

---

## ⚠️ 脚本运行错误的原因

### 错误1：编码问题（已修复）

**旧脚本：** `配置防火墙.bat`（包含中文，可能乱码）
**新脚本：** `setup-firewall.bat`（纯英文，无编码问题）

**提示：** 如果你看到 `��权限运行` 这种乱码，说明使用了旧脚本。

### 错误2：权限不足

**错误提示：**
```
[ERROR] Administrator privileges required!
```

**解决方法：**
- ❌ 双击运行（普通权限）
- ✅ **右键点击** → **"以管理员身份运行"**

---

## 📋 配置的端口清单

| 端口 | 协议 | 用途 | 在哪端需要 |
|------|------|------|-----------|
| 8244 | UDP | Leader 接收心跳 | **Leader** |
| 8245 | UDP | Leader 服务发现 | **Leader** |
| 8246 | TCP | Leader 接收文件 | **Leader** |
| 8247 | UDP | Client 接收命令 | Client（可选） |

---

## ✔️ 验证配置成功

### 方法1：查看防火墙规则

打开 PowerShell，执行：
```powershell
Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*RecSync*"}
```

应该看到 4 条规则：
```
RecSync Leader - RPC (UDP 8244)
RecSync Leader - File Transfer (TCP 8246)
RecSync Leader - Discovery (UDP 8245)
RecSync Client - RPC (UDP 8247)
```

### 方法2：查看端口监听

在 Leader 机器上，打开 PowerShell：
```powershell
netstat -an | findstr "8244"
```

应该看到：
```
UDP    0.0.0.0:8244           *:*
```

**重要：** 必须是 `0.0.0.0:8244`，不是 `127.0.0.1:8244`

---

## 🌐 其他必要设置

### WiFi 必须设置为"专用网络"

1. **设置** → **网络和 Internet** → **WiFi**
2. 点击已连接的 WiFi 网络
3. 在"网络配置文件"下，选择 **专用**

**为什么？** 防火墙规则只在"专用"和"域"配置文件下生效。

---

## 🆘 如果仍然无法连接

### 检查清单：

- [ ] 脚本已在 Leader 机器上以**管理员身份**运行
- [ ] WiFi 已设置为**"专用网络"**
- [ ] 所有设备连接到**同一个 WiFi**
- [ ] Leader 应用已重启（应用代码更新）
- [ ] Client 应用已重启

### 快速测试：

在 Client 机器上 ping Leader：
```bash
ping 192.168.1.100
```

- ✅ **能 ping 通**：网络正常，问题在防火墙或代码
- ❌ **不能 ping 通**：网络隔离（可能是 AP 隔离）

---

## 📚 相关文档

- **详细故障排除：** `TROUBLESHOOTING_NETWORK.md`
- **完整配置指南：** `FIREWALL_SETUP.md`
- **修复说明：** `网络连接问题修复说明.md`

---

## 🎯 总结

| 问题 | 答案 |
|------|------|
| **脚本在哪端运行？** | **Leader 端**（运行 Leader 应用的电脑） |
| **如何运行？** | 右键 → "以管理员身份运行" |
| **Client 需要运行吗？** | 通常**不需要** |
| **还需要什么设置？** | WiFi 设为"专用网络" |

---

**文档版本：** V1.0
**更新日期：** 2024-01-15
