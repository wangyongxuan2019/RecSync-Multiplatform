# RecSync 归档目录结构说明

## 📁 自动分层归档结构

从本版本开始，RecSync 采用全新的自动分层归档系统，使测试者信息与视频文件的关系更加清晰。

---

## 🗂️ 目录结构示例

```
RecSyncArchive/
├── s01/                                    # 测试者s01的所有数据
│   ├── subject_info.properties             # 测试者基本信息
│   ├── m01/                                # 动作m01
│   │   ├── e1/                             # 回合e1
│   │   │   ├── r0000/                      # 正式录制
│   │   │   │   ├── front_20260117143025.mp4     # 前置摄像头视频
│   │   │   │   ├── side_20260117143025.mp4      # 侧面摄像头视频
│   │   │   │   ├── top_20260117143025.mp4       # 顶部摄像头视频
│   │   │   │   └── batch_info.properties        # 批次信息（包含测试者状态）
│   │   │   ├── r0001/                      # 第1次重测
│   │   │   │   ├── front_20260117143156.mp4
│   │   │   │   ├── side_20260117143156.mp4
│   │   │   │   └── batch_info.properties
│   │   │   └── r0002/                      # 第2次重测
│   │   │       ├── front_20260117143320.mp4
│   │   │       └── batch_info.properties
│   │   ├── e2/                             # 回合e2
│   │   │   └── r0000/
│   │   │       ├── front_20260117144020.mp4
│   │   │       └── batch_info.properties
│   │   └── e3/                             # 回合e3
│   ├── m02/                                # 动作m02
│   │   ├── e1/
│   │   │   └── r0000/
│   │   │       ├── front_20260117145030.mp4
│   │   │       └── batch_info.properties
│   │   └── e2/
│   └── m03/                                # 动作m03
├── s02/                                    # 测试者s02
│   ├── subject_info.properties
│   ├── m01/
│   │   └── e1/
│   │       └── r0000/
│   │           ├── front_20260117150025.mp4
│   │           └── batch_info.properties
│   └── m02/
├── s03/                                    # 测试者s03
│   └── subject_info.properties
├── subject_info_template.properties        # 测试者信息模板（全局）
└── subjects_summary.csv                    # 所有测试者汇总CSV
```

---

## 📋 层次结构说明

### 第1层：测试者ID（如 `s01`, `s02`）
- 包含该测试者的所有录制数据
- 包含 `subject_info.properties` - 测试者的基本信息（姓名、年龄、性别、体重、身高、BMI）

### 第2层：动作ID（如 `m01`, `m02`）
- 测试者执行的不同动作

### 第3层：回合ID（如 `e1`, `e2`）
- 每个动作的不同回合（episode）

### 第4层：重测ID（如 `r0000`, `r0001`）
- `r0000` - 正式录制
- `r0001` - 第1次重测
- `r0002` - 第2次重测
- ...以此类推

### 最终层：视频文件和批次信息
- **视频文件**：`{设备名}_{时间戳}.mp4`
  - 例如：`front_20260117143025.mp4`, `side_20260117143025.mp4`
  - 设备名：front（前置）、side（侧面）、top（顶部）等
  - 时间戳：录制时的具体时间

- **批次信息**：`batch_info.properties`
  - 包含该次录制的所有信息：批次ID、测试者状态、实验参数等

---

## 📄 文件内容说明

### 1. `subject_info.properties` - 测试者基本信息
```properties
# Subject Information - 张三
name=张三
age=25
gender=男
weight=70.0
height=175.0
bmi=22.86
bmi_category=正常
record_time=2026-01-17 14:30:00
```

### 2. `batch_info.properties` - 批次详细信息
```properties
# Batch Info - s01 m01 e1 r0000
batch_id=20260117_143025
subject_id=s01
movement_id=m01
episode_id=e1
retake_id=r0000
name=张三
age=25
gender=男
weight=70.0
height=175.0
bmi=22.86
bmi_category=正常
record_time=2026-01-17 14:30:25
```

### 3. `subjects_summary.csv` - 汇总CSV（用于数据分析）
```csv
姓名,年龄,性别,体重(kg),身高(cm),BMI,BMI分类,记录时间,批次ID,测试者ID,动作ID,回合号,重测号
张三,25,男,70.00,175.00,22.86,正常,2026-01-17 14:30:00,20260117_143025,s01,m01,e1,r0000
张三,25,男,70.00,175.00,22.86,正常,2026-01-17 14:31:56,20260117_143156,s01,m01,e1,r0001
李四,30,女,55.00,165.00,20.20,正常,2026-01-17 15:00:25,20260117_150025,s02,m01,e1,r0000
```

---

## 🎯 使用优势

### ✅ 直观的层次结构
- 通过目录即可看出：测试者 → 动作 → 回合 → 重测 的完整层次
- 无需解析复杂的文件名

### ✅ 快速定位
- 想看 s01 的 m01 动作 e1 回合的正式录制？
- 直接进入：`RecSyncArchive/s01/m01/e1/r0000/`

### ✅ 自动关联
- 视频文件和批次信息在同一目录，天然关联
- 批次信息记录了录制时测试者的完整状态

### ✅ 易于管理
- 可以按测试者、动作、回合分别管理和备份
- 删除某个测试者的所有数据？直接删除对应目录

### ✅ 数据分析友好
- CSV文件包含所有录制的汇总信息
- 批次信息文件可用于详细分析

---

## 🔄 工作流程

### 1. 准备阶段
```
1. 填写测试者信息（姓名、年龄、性别、体重、身高）
2. 点击"保存测试者信息"
   → 创建 RecSyncArchive/s01/subject_info.properties
```

### 2. 录制阶段
```
1. 设置：测试者=s01, 动作=m01, 回合=e1
2. 点击"开始录制"
   → 自动创建目录：RecSyncArchive/s01/m01/e1/r0000/
   → 保存批次信息：batch_info.properties
   → 客户端录制视频上传到该目录
3. 停止录制
   → 自动递增到 e2
```

### 3. 重测场景
```
1. 点击"重测"按钮
   → 回退到 e1，重测号变为 r0001
2. 开始录制
   → 视频保存到：RecSyncArchive/s01/m01/e1/r0001/
3. 停止录制
   → 重测号重置为 r0000，回合号恢复到 e1
```

### 4. 切换测试者
```
1. 点击"下一测试者"
   → 自动递增：s01 → s02
   → 检查是否存在 s02/subject_info.properties

   如果存在：
   - 提示"发现测试者 s02 的信息"
   - 可选择加载或跳过

   如果不存在：
   - 提示"切换到新测试者 s02"
   - 可选择新建信息、从模板导入或继续
```

---

## 🛠️ 技术实现

### Leader端
- **FileReceiveServer**: 自动解析文件名，创建分层目录
- **LeaderApplication**:
  - 保存测试者信息到 `{测试者ID}/subject_info.properties`
  - 保存批次信息到 `{测试者ID}/{动作ID}/{回合ID}/{重测ID}/batch_info.properties`

### Client端
- 视频文件命名：`{设备名}_{测试者ID}_{动作ID}_{时间戳}_{回合ID}[_retake{N}].mp4`
- Leader端接收后自动解析并归档

---

## ⚠️ 注意事项

1. **目录自动创建**：系统会自动创建所需的所有目录，无需手动创建

2. **文件命名**：客户端生成的文件名必须符合格式，否则无法自动归档
   - 正确：`front_s01_m01_20260117143025_e1.mp4`
   - 错误：`video.mp4`（无法解析，将使用旧的平铺归档）

3. **CSV汇总**：`subjects_summary.csv` 会自动追加记录，建议定期备份

4. **兼容性**：如果文件名无法解析，系统会自动回退到按设备名分类的旧逻辑

---

## 📊 数据分析示例

### 查找某个测试者的所有录制
```bash
cd RecSyncArchive/s01
ls -R
```

### 导出特定测试者的CSV数据
```bash
grep "s01" subjects_summary.csv > s01_summary.csv
```

### 批量处理某个动作的视频
```bash
cd RecSyncArchive/s01/m01
find . -name "*.mp4" -exec ffmpeg -i {} ... \;
```

---

## 🔮 未来扩展

该归档结构预留了扩展空间：
- 可在批次目录中添加其他分析文件（如运动学数据）
- 可在测试者目录中添加更多元数据
- 目录结构可轻松适配数据库导入

---

**生成时间**: 2026-01-17
**版本**: RecSync v1.0 - 自动分层归档系统
