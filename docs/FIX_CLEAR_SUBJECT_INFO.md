# 切换测试者时清空输入框 - 重要修复说明

## 🔴 修复的问题

### 原问题描述
在修复前，切换测试者时存在**严重的数据混淆风险**：

```
场景重现：
1. 测试者 s01：
   姓名：张三
   年龄：25
   性别：男
   体重：70kg
   身高：175cm

2. 点击"下一测试者" → s02

3. 用户选择"跳过"或"继续"

4. 输入框仍然显示：
   姓名：张三  ← ❌ 还是s01的信息！
   年龄：25
   性别：男
   体重：70kg
   身高：175cm

5. 开始录制 → 系统保存：
   RecSyncArchive/s02/m01/e1/r0000/batch_info.properties
   {
     subject_id: s02     ← 新测试者ID
     name: 张三          ← ❌ 旧测试者的姓名！
     age: 25            ← ❌ 旧测试者的年龄！
     ...
   }

结果：s02的录制数据中包含了s01的个人信息！
```

### 问题严重性
- 🔴 **数据完整性破坏**：测试者ID和个人信息不匹配
- 🔴 **分析结果错误**：后期数据分析会得出错误结论
- 🔴 **隐私风险**：一个测试者的信息被错误地关联到另一个测试者
- 🔴 **难以发现**：用户可能不会注意到输入框还保留着旧信息

---

## ✅ 修复方案

### 核心原则
**只要不是明确加载信息，就清空输入框**

### 修复后的逻辑

#### 场景1：发现已保存的测试者信息文件

**对话框**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
切换测试者
发现测试者 s02 的信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

是否加载已保存的测试者信息？

• 加载信息 - 使用保存的测试者信息
• 跳过 - 清空当前输入框（避免误用上一个测试者的信息）

[✅ 加载信息]  [⏭️ 跳过并清空]  [取消]
```

**用户选择的结果**：

| 选择 | 输入框处理 | 说明 |
|-----|----------|------|
| ✅ 加载信息 | **覆盖**为已保存的信息 | 明确使用该测试者的信息 ✅ |
| ⏭️ 跳过并清空 | **清空**所有输入框 | 避免误用上一个测试者信息 ✅ |
| 取消 | 保持不变 | 不切换测试者 |

#### 场景2：未找到测试者信息文件

**对话框**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
切换测试者
切换到新测试者 s02
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

未找到该测试者的信息文件。

请选择操作：
• 新建信息 - 清空输入框，手动填写新测试者信息
• 从模板导入 - 从模板文件快速导入信息
• 继续 - 清空输入框，暂不填写（可稍后填写）

[✏️ 新建信息]  [📋 从模板导入]  [▶️ 继续（清空）]  [取消]
```

**用户选择的结果**：

| 选择 | 输入框处理 | 说明 |
|-----|----------|------|
| ✏️ 新建信息 | **清空**所有输入框 | 准备手动填写新信息 ✅ |
| 📋 从模板导入 | **覆盖**为模板信息 | 使用模板快速填写 ✅ |
| ▶️ 继续（清空） | **清空**所有输入框 | 避免误用上一个测试者信息 ✅ |
| 取消 | 保持不变 | 不切换测试者 |

---

## 🔧 代码修改详情

### 修改1：场景1 - "跳过"选项

**修改前**：
```java
} else if (response == skipBtn) {
    // 仅切换ID
    doSubjectSwitch(nextSubjectId);
    updateStatusBarSuccess("已切换到测试者: " + nextSubjectId + "，未加载信息");
}
```

**修改后**：
```java
} else if (response == skipBtn) {
    // 仅切换ID - 清空输入框，避免误用上一个测试者的信息
    clearSubjectInfo();  // ← 关键：清空输入框
    doSubjectSwitch(nextSubjectId);
    updateStatusBarSuccess("已切换到测试者 " + nextSubjectId + "，信息已清空");
    logger.info("切换到测试者: {}, 信息已清空（避免误用）", nextSubjectId);
}
```

### 修改2：场景2 - "继续"选项

**修改前**：
```java
} else if (response == continueBtn) {
    // 仅切换
    doSubjectSwitch(nextSubjectId);
    updateStatusBarSuccess("已切换到测试者: " + nextSubjectId);
}
```

**修改后**：
```java
} else if (response == continueBtn) {
    // 仅切换 - 清空输入框，避免误用上一个测试者的信息
    clearSubjectInfo();  // ← 关键：清空输入框
    doSubjectSwitch(nextSubjectId);
    updateStatusBarSuccess("已切换到测试者 " + nextSubjectId + "，信息已清空");
    logger.info("切换到测试者: {}, 信息已清空（避免误用）", nextSubjectId);
}
```

### 修改3：对话框文案优化

**场景1 - 发现信息文件**：
```java
// 修改前
ButtonType skipBtn = new ButtonType("⏭️ 跳过（仅切换ID）", ...);
confirmDialog.setContentText("是否加载已保存的测试者信息？");

// 修改后
ButtonType skipBtn = new ButtonType("⏭️ 跳过并清空", ...);
confirmDialog.setContentText(
    "是否加载已保存的测试者信息？\n\n" +
    "• 加载信息 - 使用保存的测试者信息\n" +
    "• 跳过 - 清空当前输入框（避免误用上一个测试者的信息）"
);
```

**场景2 - 未找到信息文件**：
```java
// 修改前
ButtonType continueBtn = new ButtonType("▶️ 继续", ...);
infoDialog.setContentText(
    "• 新建信息 - 在下方面板中填写信息\n" +
    "• 从模板导入 - 快速填写信息\n" +
    "• 继续 - 暂不填写信息"
);

// 修改后
ButtonType continueBtn = new ButtonType("▶️ 继续（清空）", ...);
infoDialog.setContentText(
    "• 新建信息 - 清空输入框，手动填写新测试者信息\n" +
    "• 从模板导入 - 从模板文件快速导入信息\n" +
    "• 继续 - 清空输入框，暂不填写（可稍后填写）"
);
```

---

## 📊 修复前后对比

### 修复前的风险场景

```
步骤1：测试者s01录制完成
├── 姓名：张三
├── 年龄：25
├── 体重：70kg
└── ...

步骤2：切换到s02，选择"跳过"
├── 输入框仍显示：张三、25、70kg...  ← ❌ 保留了旧信息
└── 测试者ID：s02

步骤3：开始录制
├── 系统保存到：RecSyncArchive/s02/m01/e1/r0000/
└── batch_info.properties:
    {
      subject_id: s02,    ← 新ID
      name: 张三,         ← ❌ 旧姓名
      age: 25,           ← ❌ 旧年龄
      weight: 70.0       ← ❌ 旧体重
    }

结果：数据混乱！s02的录制包含了s01的个人信息！
```

### 修复后的正确流程

```
步骤1：测试者s01录制完成
├── 姓名：张三
├── 年龄：25
├── 体重：70kg
└── ...

步骤2：切换到s02，选择"跳过并清空"
├── 输入框清空：（空）  ← ✅ 已清空
└── 测试者ID：s02

步骤3：开始录制
├── 系统检测到未填写信息
├── 弹出提醒："未填写测试者信息"
└── 用户可选择：
    • 取消，先填写信息（推荐）
    • 继续录制（不保存测试者信息）

结果1（用户选择取消并填写）：
├── 返回填写s02的信息
└── 重新开始录制
    RecSyncArchive/s02/m01/e1/r0000/batch_info.properties:
    {
      subject_id: s02,     ← 新ID
      name: 李四,          ← ✅ 正确的新姓名
      age: 30,            ← ✅ 正确的新年龄
      weight: 65.0        ← ✅ 正确的新体重
    }

结果2（用户选择继续录制）：
├── 直接录制，不保存测试者信息
└── RecSyncArchive/s02/m01/e1/r0000/
    （只有视频文件，无batch_info.properties）
```

---

## 🎯 设计优势

### ✅ 数据安全
- 彻底避免测试者信息混淆
- 每次切换测试者都是"干净"的状态
- 强制用户为新测试者填写或确认信息

### ✅ 用户友好
- 文案明确说明会"清空"
- 按钮名称直观（"跳过并清空"、"继续（清空）"）
- 配合录制前的提醒，双重保护

### ✅ 灵活性
- 允许加载已保存的信息（快速）
- 允许从模板导入（标准化）
- 允许暂不填写（灵活），但会清空避免误用

### ✅ 可追溯
- 日志明确记录"信息已清空（避免误用）"
- 便于后期审计和问题排查

---

## 📝 使用建议

### 推荐工作流程

**场景1：连续录制多个测试者**
```
1. 测试者s01：填写信息 → 保存 → 录制
2. 切换到s02 → 选择"新建信息" → 填写新信息 → 保存 → 录制
3. 切换到s03 → 选择"新建信息" → 填写新信息 → 保存 → 录制
```

**场景2：重复测试同一测试者**
```
1. 测试者s01：填写信息 → 保存 → 录制
2. 切换到s02 → 录制其他测试者
3. 切换回s01 → 选择"加载信息" → 自动填充s01的信息 → 录制
```

**场景3：使用模板快速录入**
```
1. 准备模板文件（标准化的测试者信息）
2. 切换到s01 → 选择"从模板导入" → 修改姓名等个性化信息 → 保存 → 录制
3. 切换到s02 → 选择"从模板导入" → 修改姓名等个性化信息 → 保存 → 录制
```

### 注意事项

❌ **错误做法**：
```
切换测试者后，直接开始录制，依赖旧的输入框内容
→ 修复前：会导致数据混淆
→ 修复后：输入框已清空，会触发提醒
```

✅ **正确做法**：
```
切换测试者后，根据对话框提示选择操作：
• 有已保存信息 → 选择"加载信息"
• 无已保存信息 → 选择"新建信息"或"从模板导入"
• 暂不填写 → 选择"继续（清空）"，录制时会提醒
```

---

## 🔍 测试验证

### 测试用例1：切换测试者并跳过

**步骤**：
1. 测试者s01：姓名=张三，年龄=25
2. 点击"保存测试者信息"
3. 点击"下一测试者" → s02
4. 发现s02的信息文件
5. 选择"跳过并清空"

**预期结果**：
- ✅ 测试者ID变为s02
- ✅ 输入框全部清空
- ✅ 状态栏显示："已切换到测试者 s02，信息已清空"
- ✅ 日志记录："切换到测试者: s02, 信息已清空（避免误用）"

### 测试用例2：切换测试者并继续

**步骤**：
1. 测试者s01：姓名=张三，年龄=25
2. 点击"下一测试者" → s02
3. 未找到s02的信息文件
4. 选择"继续（清空）"

**预期结果**：
- ✅ 测试者ID变为s02
- ✅ 输入框全部清空
- ✅ 状态栏显示："已切换到测试者 s02，信息已清空"
- ✅ 点击"开始录制"时会提醒未填写信息

### 测试用例3：切换测试者并加载信息

**步骤**：
1. 测试者s01：姓名=张三，已保存
2. 切换到s02：姓名=李四，已保存
3. 切换回s01
4. 选择"加载信息"

**预期结果**：
- ✅ 测试者ID变为s01
- ✅ 输入框填充为：姓名=张三（s01的信息）
- ✅ 不会保留s02的信息

---

## 📈 影响评估

### 对现有用户的影响

**正面影响**：
- ✅ 彻底避免数据混淆的风险
- ✅ 提高数据质量和可靠性
- ✅ 更清晰的用户体验

**潜在影响**：
- ⚠️ 用户需要习惯"切换时会清空"的行为
- ⚠️ 如果多个测试者信息相似，需要重复输入
- 💡 建议：使用模板功能可以快速填写

### 兼容性

**向后兼容**：
- ✅ 不影响已保存的数据
- ✅ 不影响已有的录制文件
- ✅ 只改变UI交互行为

---

## 🚀 后续优化建议

### 可选功能1：保留上次输入作为参考
```
切换测试者时，在对话框中显示上一个测试者的信息作为参考：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
切换到新测试者 s02

上一个测试者（s01）的信息：
姓名：张三，年龄：25，性别：男，体重：70kg，身高：175cm

请选择操作：
[新建信息]  [从模板导入]  [复制上一个测试者信息]  [继续]
```

### 可选功能2：批量导入测试者信息
```
从CSV文件批量导入多个测试者的信息：
s01,张三,25,男,70,175
s02,李四,30,女,55,165
s03,王五,28,男,75,180

切换测试者时自动查找匹配的信息
```

### 可选功能3：历史记录提示
```
切换到s01时，检测到上次录制记录：
"上次录制时间：2026-01-17 14:30，姓名：张三"
是否加载上次的信息？
```

---

**修复日期**：2026-01-17
**版本**：v1.2 - 切换测试者时清空输入框
**影响范围**：LeaderApplication.java
**编译状态**：✅ BUILD SUCCESSFUL
**风险等级**：🟢 低风险（只影响UI行为，不影响数据结构）
**重要性**：🔴 高（修复严重的数据完整性问题）
