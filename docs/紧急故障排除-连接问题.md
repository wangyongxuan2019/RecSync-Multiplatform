# ğŸš¨ ç´§æ€¥æ•…éšœæ’é™¤ï¼šClient æ— æ³•è¿æ¥åˆ° Leader

## ç—‡çŠ¶

**Client å¯åŠ¨åï¼ŒLeader ç«¯å®Œå…¨æ²¡æœ‰æ—¥å¿—å‡ºç°** - è¿™è¯´æ˜ UDP æ•°æ®åŒ…æ ¹æœ¬æ²¡æœ‰åˆ°è¾¾ Leaderã€‚

---

## ğŸ¯ å¿«é€Ÿè¯Šæ–­æ­¥éª¤ï¼ˆå¿…è¯»ï¼ï¼‰

### ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨è¯Šæ–­å·¥å…·ï¼ˆæœ€é‡è¦ï¼ï¼‰

#### åœ¨ Leader æœºå™¨ä¸Šï¼š

1. **å…³é—­ Leader åº”ç”¨**ï¼ˆé‡è¦ï¼ï¼‰
2. è¿è¡Œ `diagnose-network-leader.bat`
3. æŒ‰ç…§æç¤ºæ“ä½œï¼Œä¼šæ˜¾ç¤ºï¼š
   - Leader IP åœ°å€
   - é˜²ç«å¢™è§„åˆ™çŠ¶æ€
   - ç«¯å£ç›‘å¬çŠ¶æ€
   - ç½‘ç»œé…ç½®æ–‡ä»¶
4. æœ€åä¼šå¯åŠ¨ UDP ç›‘å¬å™¨

#### åœ¨ Client æœºå™¨ä¸Šï¼š

1. è¿è¡Œ `test-client-connection.bat`
2. è¾“å…¥ Leader çš„ IP åœ°å€ï¼ˆä»ä¸Šé¢è·å–ï¼‰
3. ä¼šè‡ªåŠ¨å‘é€æµ‹è¯•æ•°æ®åŒ…

#### åˆ¤æ–­ç»“æœï¼š

- âœ… **Leader çª—å£æ˜¾ç¤ºæ”¶åˆ°æ•°æ®åŒ…** â†’ ç½‘ç»œæ­£å¸¸ï¼Œé—®é¢˜åœ¨åº”ç”¨å±‚
- âŒ **Leader çª—å£æ²¡æœ‰ä»»ä½•æ˜¾ç¤º** â†’ ç½‘ç»œä¸é€šï¼Œç»§ç»­ä¸‹é¢çš„æ­¥éª¤

---

### ç¬¬äºŒæ­¥ï¼šé€é¡¹æ£€æŸ¥ï¼ˆæŒ‰é¡ºåºï¼‰

#### æ£€æŸ¥ 1ï¼šé˜²ç«å¢™è§„åˆ™

åœ¨ Leader æœºå™¨ä¸Šï¼Œæ‰“å¼€ PowerShellï¼ˆç®¡ç†å‘˜ï¼‰ï¼š

```powershell
Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*RecSync*"} | Select-Object DisplayName, Enabled, Direction, Action
```

**å¿…é¡»çœ‹åˆ° 4 æ¡è§„åˆ™ï¼Œä¸”å…¨éƒ¨ Enabled=True:**
```
RecSync Leader - RPC (UDP 8244)              True    Inbound   Allow
RecSync Leader - File Transfer (TCP 8246)    True    Inbound   Allow
RecSync Leader - Discovery (UDP 8245)        True    Inbound   Allow
RecSync Client - RPC (UDP 8247)              True    Inbound   Allow
```

**å¦‚æœæ²¡æœ‰ï¼š**
```bash
# å³é”® â†’ "ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
setup-firewall.bat
```

#### æ£€æŸ¥ 2ï¼šç½‘ç»œé…ç½®æ–‡ä»¶

åœ¨ Leader æœºå™¨ä¸Šï¼š

```powershell
Get-NetConnectionProfile
```

**å¿…é¡»æ˜¯ï¼š**
```
NetworkCategory : Private
```

**å¦‚æœæ˜¯ Publicï¼š**
1. è®¾ç½® â†’ ç½‘ç»œå’Œ Internet â†’ WiFi
2. ç‚¹å‡»å·²è¿æ¥çš„ WiFi
3. ç½‘ç»œé…ç½®æ–‡ä»¶ â†’ é€‰æ‹©"ä¸“ç”¨"

#### æ£€æŸ¥ 3ï¼šç«¯å£ç›‘å¬çŠ¶æ€

åœ¨ Leader æœºå™¨ä¸Šï¼ˆ**Leader åº”ç”¨å¿…é¡»æ­£åœ¨è¿è¡Œ**ï¼‰ï¼š

```powershell
netstat -an | findstr "8244"
```

**å¿…é¡»çœ‹åˆ°ï¼š**
```
UDP    0.0.0.0:8244           *:*
```

**é‡è¦ï¼š** å¿…é¡»æ˜¯ `0.0.0.0:8244`ï¼Œå¦‚æœæ˜¯ `127.0.0.1:8244` è¯´æ˜ä»£ç æ²¡æœ‰æ›´æ–°ï¼

**å¦‚æœç«¯å£ä¸åœ¨ç›‘å¬ï¼š**
- Leader åº”ç”¨æ²¡æœ‰è¿è¡Œï¼Œæˆ–è€…
- ä»£ç æ²¡æœ‰é‡æ–°ç¼–è¯‘ï¼Œè¿è¡Œï¼š`gradlew build`

#### æ£€æŸ¥ 4ï¼šç½‘ç»œè¿é€šæ€§

åœ¨ Client æœºå™¨ä¸Šï¼š

```bash
ping <Leaderçš„IPåœ°å€>
```

- âœ… **æ”¶åˆ°å›å¤** â†’ ç½‘ç»œå±‚æ­£å¸¸
- âŒ **è¯·æ±‚è¶…æ—¶** â†’ ç½‘ç»œéš”ç¦»é—®é¢˜

**å¯èƒ½åŸå› ï¼š**
1. **AP éš”ç¦»**ï¼ˆè·¯ç”±å™¨è®¾ç½®é˜»æ­¢å®¢æˆ·ç«¯äº’ç›¸é€šä¿¡ï¼‰
   - ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢
   - æŸ¥æ‰¾"AP éš”ç¦»"æˆ–"å®¢æˆ·ç«¯éš”ç¦»"é€‰é¡¹
   - å…³é—­è¯¥åŠŸèƒ½

2. **ä¸åœ¨åŒä¸€å­ç½‘**
   - ç¡®è®¤ä¸¤å°æœºå™¨éƒ½è¿æ¥åˆ°åŒä¸€ä¸ª WiFi
   - æ£€æŸ¥ IP åœ°å€æ˜¯å¦åœ¨åŒä¸€ç½‘æ®µï¼ˆå¦‚éƒ½æ˜¯ 192.168.1.xï¼‰

3. **é˜²ç«å¢™é˜»æ­¢ ICMP**
   - åœ¨ Leader æœºå™¨ä¸Šä¸´æ—¶å…è®¸ pingï¼š
     ```powershell
     netsh advfirewall firewall add rule name="ICMPv4" protocol=icmpv4:8,any dir=in action=allow
     ```

#### æ£€æŸ¥ 5ï¼šæŸ¥çœ‹åº”ç”¨æ—¥å¿—

**Leader ç«¯æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š**
```
âœ… RPCæœåŠ¡å·²å¯åŠ¨ - ç»‘å®šåœ°å€: 0.0.0.0:8244 (ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£)
   è¯·ç¡®ä¿é˜²ç«å¢™å…è®¸UDPç«¯å£ 8244 çš„å…¥ç«™è¿æ¥
RPCç›‘å¬çº¿ç¨‹å·²å¯åŠ¨ï¼Œæ­£åœ¨ç›‘å¬ç«¯å£ 8244 ...
```

**å¦‚æœçœ‹åˆ° `127.0.0.1:8244` è€Œä¸æ˜¯ `0.0.0.0:8244`ï¼š**
- ä»£ç æ²¡æœ‰æ›´æ–°
- è¿è¡Œ `gradlew build` é‡æ–°ç¼–è¯‘
- é‡å¯ Leader åº”ç”¨

**Client ç«¯æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š**
```
âœ… SoftwareSyncClientå·²å¯åŠ¨: Client-XXX, Leaderç«¯å£: 8244
ğŸ’“ [å¿ƒè·³] å‘é€åˆ° Leader: 192.168.1.100:8244
   payload: clientName='Client-XXX', localIP='192.168.1.101', synced=false
   å®Œæ•´æ¶ˆæ¯: 'Client-XXX,192.168.1.101,false'
```

**å½“ Leader æ”¶åˆ°å¿ƒè·³æ—¶ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š**
```
ğŸ“¥ æ”¶åˆ°å¿ƒè·³è¯·æ±‚: payload='Client-XXX,192.168.1.101,false', from=192.168.1.101
   è§£æç»“æœ: å®¢æˆ·ç«¯åç§°='Client-XXX', å®¢æˆ·ç«¯IP='192.168.1.101', synced=false
âœ… *** æ–°å®¢æˆ·ç«¯å·²è¿æ¥ ***: Client-XXX (192.168.1.101) - å½“å‰å®¢æˆ·ç«¯æ•°: 1/10
```

---

## ğŸ”¥ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šé˜²ç«å¢™è§„åˆ™å­˜åœ¨ä½†ä»ç„¶æ— æ³•è¿æ¥

**å¯èƒ½åŸå› ï¼š** å…¶ä»–å®‰å…¨è½¯ä»¶ï¼ˆ360ã€è…¾è®¯ç®¡å®¶ã€Norton ç­‰ï¼‰ä¹Ÿåœ¨é˜»æ­¢è¿æ¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. ä¸´æ—¶ç¦ç”¨æ‰€æœ‰ç¬¬ä¸‰æ–¹å®‰å…¨è½¯ä»¶
2. å¦‚æœè¿æ¥æˆåŠŸï¼Œåœ¨å®‰å…¨è½¯ä»¶ä¸­æ·»åŠ  RecSync ä¸ºä¿¡ä»»ç¨‹åº

### é—®é¢˜ 2ï¼šæœ¬æœº Client å¯ä»¥è¿æ¥ï¼Œå…¶ä»–æœºå™¨ä¸è¡Œ

**åŸå› ï¼š** æœ¬æœºé€šä¿¡ä½¿ç”¨ loopbackï¼ˆ127.0.0.1ï¼‰ï¼Œä¸ç»è¿‡ç½‘ç»œæ¥å£å’Œé˜²ç«å¢™

**è§£å†³æ–¹æ¡ˆï¼š** è¿™è¯æ˜æ˜¯é˜²ç«å¢™æˆ–ç½‘ç»œé…ç½®é—®é¢˜ï¼Œé‡ç‚¹æ£€æŸ¥ä¸Šè¿°æ£€æŸ¥é¡¹

### é—®é¢˜ 3ï¼šå¯ä»¥ ping é€šä½† UDP æ— æ³•åˆ°è¾¾

**åŸå› ï¼š** ICMPï¼ˆpingï¼‰å’Œ UDP æ˜¯ä¸åŒåè®®ï¼Œé˜²ç«å¢™å¯èƒ½åªé˜»æ­¢ UDP

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤é˜²ç«å¢™è§„åˆ™æ­£ç¡®
2. ç¡®è®¤ç½‘ç»œé…ç½®æ–‡ä»¶ä¸º"ä¸“ç”¨"
3. ä¸´æ—¶å®Œå…¨å…³é—­ Windows é˜²ç«å¢™æµ‹è¯•ï¼ˆä¸æ¨èé•¿æœŸä½¿ç”¨ï¼‰ï¼š
   ```powershell
   # ä¸´æ—¶å…³é—­ï¼ˆæµ‹è¯•ç”¨ï¼‰
   netsh advfirewall set allprofiles state off

   # æµ‹è¯•åè®°å¾—é‡æ–°å¼€å¯
   netsh advfirewall set allprofiles state on
   ```

### é—®é¢˜ 4ï¼šçœ‹åˆ°"ç«¯å£å·²è¢«å ç”¨"é”™è¯¯

**åŸå› ï¼š** å¦ä¸€ä¸ªç¨‹åºå ç”¨äº† 8244 æˆ–å…¶ä»–ç«¯å£

**æŸ¥æ‰¾å ç”¨ç«¯å£çš„ç¨‹åºï¼š**
```powershell
netstat -ano | findstr "8244"
# è®°ä¸‹æœ€åä¸€åˆ—çš„ PID

tasklist | findstr "<PID>"
# æŸ¥çœ‹æ˜¯å“ªä¸ªç¨‹åº
```

**è§£å†³æ–¹æ¡ˆï¼š**
- å…³é—­å ç”¨ç«¯å£çš„ç¨‹åºï¼Œæˆ–
- ä¿®æ”¹ SyncConstants.java ä¸­çš„ç«¯å£å·ï¼ˆä¸æ¨èï¼‰

### é—®é¢˜ 5ï¼šä¼ä¸šæˆ–å­¦æ ¡ç½‘ç»œç¯å¢ƒ

**ç‰¹å¾ï¼š**
- æœ‰ç»Ÿä¸€çš„ç½‘ç»œç®¡ç†
- å¯èƒ½æœ‰ä¸¥æ ¼çš„é˜²ç«å¢™ç­–ç•¥
- å¯èƒ½æœ‰ VLAN éš”ç¦»

**è§£å†³æ–¹æ¡ˆï¼š**
1. è”ç³» IT éƒ¨é—¨è¯·æ±‚å¼€æ”¾ç«¯å£
2. ä½¿ç”¨ç‹¬ç«‹çš„ä¾¿æºå¼è·¯ç”±å™¨åˆ›å»ºç§æœ‰ç½‘ç»œ
3. ä½¿ç”¨æœ‰çº¿è¿æ¥é€šè¿‡äº¤æ¢æœºè¿æ¥æ‰€æœ‰è®¾å¤‡

---

## ğŸ› ï¸ é«˜çº§è¯Šæ–­

### ä½¿ç”¨ Wireshark æŠ“åŒ…

1. ä¸‹è½½å®‰è£… [Wireshark](https://www.wireshark.org/)
2. åœ¨ Leader æœºå™¨ä¸Šå¯åŠ¨ Wireshark
3. é€‰æ‹©å½“å‰ä½¿ç”¨çš„ç½‘ç»œæ¥å£ï¼ˆWiFi æˆ–ä»¥å¤ªç½‘ï¼‰
4. è¿‡æ»¤å™¨è¾“å…¥ï¼š`udp.port == 8244`
5. å¯åŠ¨ Clientï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰æ•°æ®åŒ…åˆ°è¾¾

**åˆ¤æ–­ï¼š**
- âœ… **çœ‹åˆ°æ•°æ®åŒ…** â†’ è¯´æ˜ UDP åˆ°è¾¾äº†ï¼Œé—®é¢˜åœ¨åº”ç”¨å±‚
- âŒ **æ²¡æœ‰æ•°æ®åŒ…** â†’ ç½‘ç»œå±‚é¢è¢«é˜»æ­¢

### ä¸´æ—¶ç®€åŒ–æµ‹è¯•

**æœ€å°åŒ–æµ‹è¯•ï¼ˆæ’é™¤åº”ç”¨é—®é¢˜ï¼‰ï¼š**

åœ¨ Leader æœºå™¨ä¸Šï¼Œæ‰“å¼€ PowerShellï¼š
```powershell
$endpoint = New-Object System.Net.IPEndPoint([System.Net.IPAddress]::Any, 8244)
$udpClient = New-Object System.Net.Sockets.UdpClient 8244
Write-Host "Listening on port 8244..."
while($true) {
    $data = $udpClient.Receive([ref]$endpoint)
    $msg = [System.Text.Encoding]::ASCII.GetString($data)
    Write-Host "Received from $($endpoint.Address): $msg"
}
```

åœ¨ Client æœºå™¨ä¸Šï¼Œæ‰“å¼€ PowerShellï¼š
```powershell
$udpClient = New-Object System.Net.Sockets.UdpClient
$leaderIP = "192.168.1.100"  # æ›¿æ¢ä¸ºå®é™…IP
$bytes = [System.Text.Encoding]::ASCII.GetBytes("TEST")
$udpClient.Send($bytes, $bytes.Length, $leaderIP, 8244)
Write-Host "Sent test packet"
$udpClient.Close()
```

---

## âœ… æˆåŠŸè¿æ¥çš„æ ‡å¿—

### Leader ç«¯ï¼š

**ç•Œé¢æ˜¾ç¤ºï¼š**
```
å·²è¿æ¥å®¢æˆ·ç«¯ (1/10å°)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚âœ… Client-XXX (192.168.1.101) - 2.3ms    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ—¥å¿—æ˜¾ç¤ºï¼š**
```
ğŸ“¥ æ”¶åˆ°å¿ƒè·³è¯·æ±‚: payload='Client-XXX,192.168.1.101,false', from=192.168.1.101
âœ… *** æ–°å®¢æˆ·ç«¯å·²è¿æ¥ ***: Client-XXX (192.168.1.101) - å½“å‰å®¢æˆ·ç«¯æ•°: 1/10
```

### Client ç«¯ï¼š

**ç•Œé¢æ˜¾ç¤ºï¼š**
```
çŠ¶æ€: å·²è¿æ¥åˆ°Leader âœ…
```

**æ—¥å¿—æ˜¾ç¤ºï¼š**
```
ğŸ’“ [å¿ƒè·³] å‘é€åˆ° Leader: 192.168.1.100:8244
```

---

## ğŸ“ ä»ç„¶æ— æ³•è§£å†³ï¼Ÿ

æä¾›ä»¥ä¸‹ä¿¡æ¯ä»¥è·å–å¸®åŠ©ï¼š

1. **è¯Šæ–­å·¥å…·ç»“æœ**
   - `diagnose-network-leader.bat` çš„å®Œæ•´è¾“å‡º
   - `test-client-connection.bat` çš„å®Œæ•´è¾“å‡º

2. **ç½‘ç»œç¯å¢ƒ**
   - è·¯ç”±å™¨å‹å·
   - ç½‘ç»œç±»å‹ï¼ˆå®¶åº­/ä¼ä¸š/å­¦æ ¡ï¼‰
   - æ˜¯å¦æœ‰å…¶ä»–å®‰å…¨è½¯ä»¶

3. **æ—¥å¿—æ–‡ä»¶**
   - Leader åº”ç”¨çš„å®Œæ•´æ—¥å¿—
   - Client åº”ç”¨çš„å®Œæ•´æ—¥å¿—

4. **å‘½ä»¤è¾“å‡º**
   ```powershell
   # Leader æœºå™¨
   ipconfig /all
   netstat -an | findstr "8244"
   Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*RecSync*"}
   Get-NetConnectionProfile
   ```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** V2.0ï¼ˆå¢å¼ºè¯Šæ–­ç‰ˆï¼‰
**æ›´æ–°æ—¥æœŸï¼š** 2024-01-15
